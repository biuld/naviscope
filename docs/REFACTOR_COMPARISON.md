# Naviscope å¼•æ“é‡æ„å¯¹æ¯”

## ğŸ”„ æ¶æ„å¯¹æ¯”

### å½“å‰æ¶æ„ï¼ˆåˆ†æ•£å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LSP Server    â”‚     â”‚   MCP Server    â”‚     â”‚   Shell REPL    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Arc<RwLock<     â”‚     â”‚ Arc<RwLock<     â”‚     â”‚ Arc<RwLock<     â”‚
â”‚   Option<       â”‚     â”‚   Option<       â”‚     â”‚   Naviscope>>   â”‚
â”‚   Naviscope>>>  â”‚     â”‚   Naviscope>>>  â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚ async                 â”‚ async                 â”‚ sync
         â”‚ å…‹éš†æ•´ä¸ªå›¾             â”‚ å…‹éš†æ•´ä¸ªå›¾             â”‚ å…‹éš†æ•´ä¸ªå›¾
         â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚          æ¯æ¬¡æŸ¥è¯¢éƒ½æ·±æ‹·è´ Naviscope                      â”‚
    â”‚          (æ•° MB çš„å†…å­˜åˆ†é…)                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**ï¼š
- âŒ ä¸‰ä¸ªç‹¬ç«‹çš„é”ç³»ç»Ÿï¼ˆLSP/MCP ç”¨å¼‚æ­¥é”ï¼ŒShell ç”¨åŒæ­¥é”ï¼‰
- âŒ æ¯æ¬¡æŸ¥è¯¢éƒ½å…‹éš†æ•´ä¸ªå›¾ï¼ˆæ·±æ‹·è´ï¼‰
- âŒ å†™é”æœŸé—´ï¼Œæ‰€æœ‰è¯»æ“ä½œå®Œå…¨é˜»å¡
- âŒ æ— æ³•åœ¨åŒä¸€è¿›ç¨‹ä¸­å…±äº«ç´¢å¼•

---

### æ–°æ¶æ„ï¼ˆç»Ÿä¸€å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LSP Server    â”‚     â”‚   MCP Server    â”‚     â”‚   Shell REPL    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EngineHandle    â”‚     â”‚ EngineHandle    â”‚     â”‚ EngineHandle    â”‚
â”‚   .graph()      â”‚     â”‚   .query()      â”‚     â”‚   .graph_       â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚    blocking()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   NaviscopeEngine         â”‚
                    â”‚  (ç»Ÿä¸€çš„å¼•æ“å±‚)            â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ Arc<RwLock<Arc<          â”‚
                    â”‚   CodeGraph>>>            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CodeGraph               â”‚
                    â”‚  (Arc åŒ…è£…çš„ä¸å¯å˜æ•°æ®)    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ Arc<CodeGraphInner>       â”‚
                    â”‚   - topology              â”‚
                    â”‚   - fqn_map               â”‚
                    â”‚   - ...                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…‹éš†ç­–ç•¥ï¼š
  graph() â†’ Arc::clone â†’ åªå¢åŠ å¼•ç”¨è®¡æ•° (1Î¼s)
  æŸ¥è¯¢ä½¿ç”¨åŒä¸€ä»½æ•°æ®ï¼ˆé›¶æ‹·è´ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç»Ÿä¸€çš„ `EngineHandle` æ¥å£
- âœ… å¿«ç…§è·å–æå¿«ï¼ˆArc cloneï¼Œ1Î¼sï¼‰
- âœ… æŸ¥è¯¢ä¸è¢«ç´¢å¼•é‡å»ºé˜»å¡ï¼ˆMVCCï¼‰
- âœ… å†…å­˜ä½¿ç”¨å‡å°‘ 90%

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å¿«ç…§è·å–æ€§èƒ½

| æ“ä½œ | å½“å‰æ¶æ„ | æ–°æ¶æ„ | æ”¹è¿›å€æ•° |
|------|----------|--------|----------|
| è·å–å¿«ç…§ï¼ˆå°é¡¹ç›®ï¼Œ1K èŠ‚ç‚¹ï¼‰ | ~5 ms | ~1 Î¼s | **5000x** |
| è·å–å¿«ç…§ï¼ˆä¸­é¡¹ç›®ï¼Œ10K èŠ‚ç‚¹ï¼‰ | ~50 ms | ~1 Î¼s | **50000x** |
| è·å–å¿«ç…§ï¼ˆå¤§é¡¹ç›®ï¼Œ100K èŠ‚ç‚¹ï¼‰ | ~500 ms | ~1 Î¼s | **500000x** |

**åŸå› **ï¼š
- å½“å‰ï¼šæ·±æ‹·è´æ•´ä¸ª `Naviscope`ï¼ŒåŒ…æ‹¬æ‰€æœ‰ HashMap å’Œ Graph
- æ–°æ¶æ„ï¼šåªå¢åŠ  `Arc` çš„å¼•ç”¨è®¡æ•°

---

### å†…å­˜ä½¿ç”¨å¯¹æ¯”

**åœºæ™¯**ï¼š10 ä¸ªå¹¶å‘æŸ¥è¯¢ï¼Œé¡¹ç›®å¤§å° 10K èŠ‚ç‚¹ï¼ˆ~5 MB å›¾æ•°æ®ï¼‰

| æ¶æ„ | å†…å­˜å ç”¨ | è¯´æ˜ |
|------|----------|------|
| å½“å‰ | ~50 MB | æ¯ä¸ªæŸ¥è¯¢å…‹éš†ä¸€ä»½å›¾ (10 Ã— 5 MB) |
| æ–°æ¶æ„ | ~5 MB | æ‰€æœ‰æŸ¥è¯¢å…±äº«åŒä¸€ä»½å›¾ (Arc) |

**æ”¹è¿›**ï¼š**-90%** å†…å­˜ä½¿ç”¨

---

### å¹¶å‘æ€§èƒ½å¯¹æ¯”

**åœºæ™¯**ï¼šç´¢å¼•é‡å»ºæœŸé—´çš„æŸ¥è¯¢å“åº”æ—¶é—´

```
æ—¶é—´è½´ï¼š
  0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10s
  
å½“å‰æ¶æ„ï¼š
  [ ç´¢å¼•é‡å»ºä¸­... ]
  â†“ æŸ¥è¯¢1: ç­‰å¾…...ç­‰å¾…...ç­‰å¾…...å®Œæˆ (é˜»å¡ 5s)
  â†“ æŸ¥è¯¢2: ç­‰å¾…...ç­‰å¾…...ç­‰å¾…...å®Œæˆ (é˜»å¡ 5s)
  â†“ æŸ¥è¯¢3: ç­‰å¾…...ç­‰å¾…...ç­‰å¾…...å®Œæˆ (é˜»å¡ 5s)
  
æ–°æ¶æ„ (MVCC)ï¼š
  [ ç´¢å¼•é‡å»ºä¸­... ]
  â†“ æŸ¥è¯¢1: âœ“ å®Œæˆ (ä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œ<1ms)
  â†“ æŸ¥è¯¢2: âœ“ å®Œæˆ (ä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œ<1ms)
  â†“ æŸ¥è¯¢3: âœ“ å®Œæˆ (ä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œ<1ms)
  â†“ æ–°ç´¢å¼•å°±ç»ª â†’
  â†“ æŸ¥è¯¢4: âœ“ å®Œæˆ (ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼Œ<1ms)
```

| æŒ‡æ ‡ | å½“å‰æ¶æ„ | æ–°æ¶æ„ | æ”¹è¿› |
|------|----------|--------|------|
| æŸ¥è¯¢å“åº”æ—¶é—´ï¼ˆé‡å»ºæœŸé—´ï¼‰ | é˜»å¡ï¼ˆ5s+ï¼‰ | <1ms | **âˆ** (ä»é˜»å¡åˆ°éé˜»å¡) |
| æŸ¥è¯¢æˆåŠŸç‡ | é™ä½ï¼ˆå¯èƒ½è¶…æ—¶ï¼‰ | 100% | æ˜¾è‘—æå‡ |

---

## ğŸ’» ä»£ç å¯¹æ¯”

### åœºæ™¯1ï¼šLSP Hover åŠŸèƒ½

**å½“å‰ä»£ç **ï¼š
```rust
async fn hover(&self, params: HoverParams) -> Result<Option<Hover>> {
    // 1. è·å–è¯»é”
    let lock = self.engine.read().await;
    
    // 2. æ£€æŸ¥ç´¢å¼•æ˜¯å¦å¯ç”¨
    let navi = match &*lock {
        Some(n) => n,
        None => return Ok(None),  // ç´¢å¼•æœªå°±ç»ª
    };
    
    // 3. å…‹éš†æ•´ä¸ª Naviscopeï¼ˆæ·±æ‹·è´ï¼Œå¯èƒ½æ•° MBï¼‰
    let navi_clone = navi.clone();
    drop(lock);  // é‡Šæ”¾é”
    
    // 4. åœ¨ blocking pool æ‰§è¡ŒæŸ¥è¯¢
    let result = tokio::task::spawn_blocking(move || {
        let graph = navi_clone.graph();
        graph.find_node_at(&path, line, col)
    }).await?;
    
    // ... æ„é€  Hover å“åº”
}
```

**é—®é¢˜**ï¼š
- æ·±æ‹·è´æ•´ä¸ª `Naviscope`ï¼ˆè€—æ—¶ 5-500msï¼Œå–å†³äºé¡¹ç›®å¤§å°ï¼‰
- æ¯æ¬¡ hover éƒ½åˆ†é…å¤§é‡å†…å­˜

---

**æ–°ä»£ç **ï¼š
```rust
async fn hover(&self, params: HoverParams) -> Result<Option<Hover>> {
    // 1. è·å–å¿«ç…§ï¼ˆArc cloneï¼Œ1Î¼sï¼‰
    let graph = self.engine.graph().await;
    
    // 2. åœ¨ blocking pool æ‰§è¡ŒæŸ¥è¯¢
    let result = tokio::task::spawn_blocking(move || {
        graph.find_node_at(&path, line, col)
    }).await?;
    
    // ... æ„é€  Hover å“åº”
}
```

**æ”¹è¿›**ï¼š
- âœ… ä»£ç å‡å°‘ 50%
- âœ… å¿«ç…§è·å–ä» 50ms â†’ 1Î¼s
- âœ… æ— éœ€æ£€æŸ¥ `Option<Naviscope>`ï¼Œå¼•æ“æ€»æ˜¯å¯ç”¨

---

### åœºæ™¯2ï¼šMCP æŸ¥è¯¢

**å½“å‰ä»£ç **ï¼š
```rust
pub async fn execute_query(&self, query: GraphQuery) -> Result<...> {
    // 1. è·å–æˆ–æ„å»ºç´¢å¼•
    let engine = self.get_or_build_index().await?;
    
    // 2. åœ¨ blocking pool æ‰§è¡Œ
    let result = tokio::task::spawn_blocking(move || {
        let query_engine = QueryEngine::new(engine.graph());
        query_engine.execute(&query)
    }).await?;
    
    // ...
}

async fn get_or_build_index(&self) -> Result<Naviscope> {
    let lock = self.engine.read().await;
    match &*lock {
        Some(navi) => Ok(navi.clone()),  // å…‹éš†
        None => Err(...),
    }
}
```

---

**æ–°ä»£ç **ï¼š
```rust
pub async fn execute_query(&self, query: GraphQuery) -> Result<...> {
    // ç›´æ¥è°ƒç”¨ handle.query()ï¼ˆå†…éƒ¨å¤„ç†å¿«ç…§å’Œ blockingï¼‰
    let result = self.engine.query(&query).await?;
    // ...
}
```

**æ”¹è¿›**ï¼š
- âœ… ä»£ç å‡å°‘ 70%
- âœ… æ— éœ€æ‰‹åŠ¨ç®¡ç† `get_or_build_index`
- âœ… è‡ªåŠ¨å¤„ç†å¿«ç…§å’Œçº¿ç¨‹æ± è°ƒåº¦

---

### åœºæ™¯3ï¼šShell Completer

**å½“å‰ä»£ç **ï¼š
```rust
fn complete(&mut self, line: &str, pos: usize) -> Vec<Suggestion> {
    // 1. è·å–è¯»é”ï¼ˆåŒæ­¥ï¼‰
    if let Ok(naviscope) = self.context.naviscope.read() {
        let graph = naviscope.graph();
        
        // 2. åœ¨æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹æ‰§è¡Œå¤§é‡è®¡ç®—
        let matches: Vec<String> = graph.fqn_map.keys()
            .filter(|fqn| fqn.starts_with(last_word))
            .take(20)
            .cloned()
            .collect();
        
        // ... æ›´å¤šè®¡ç®— ...
        
        suggestions.sort_by(...);
        suggestions.truncate(50);
        
        return suggestions;
    }  // è¯»é”åœ¨æ­¤å¤„æ‰é‡Šæ”¾
    
    vec![]
}
```

**é—®é¢˜**ï¼š
- è¯»é”æŒæœ‰æ—¶é—´è¿‡é•¿ï¼ˆæ•´ä¸ªè¡¥å…¨è®¡ç®—æœŸé—´ï¼‰
- é˜»æ­¢ç´¢å¼•æ›´æ–°

---

**æ–°ä»£ç **ï¼š
```rust
fn complete(&mut self, line: &str, pos: usize) -> Vec<Suggestion> {
    // 1. è·å–å¿«ç…§ï¼ˆæå¿«ï¼Œä¸é˜»å¡ï¼‰
    let graph = self.context.engine.graph_blocking();
    
    // 2. åœ¨é”å¤–æ‰§è¡Œè®¡ç®—
    let matches: Vec<String> = graph.all_fqns()
        .into_iter()
        .filter(|fqn| fqn.starts_with(last_word))
        .take(20)
        .collect();
    
    // ... æ›´å¤šè®¡ç®—ï¼ˆä¸æŒæœ‰é”ï¼‰...
    
    suggestions
}
```

**æ”¹è¿›**ï¼š
- âœ… è¯»é”æŒæœ‰æ—¶é—´ä» ~100ms â†’ <1Î¼s
- âœ… ä¸é˜»å¡ç´¢å¼•æ›´æ–°
- âœ… ä»£ç æ›´ç®€æ´

---

## ğŸ”§ è¿ç§»å¤æ‚åº¦

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | å½“å‰è¡Œæ•° | é¢„è®¡å˜æ›´ | éš¾åº¦ |
|------|----------|----------|------|
| `src/engine/mod.rs` | 0 | +500 | ğŸŸ¢ æ–°å»º |
| `src/lsp/mod.rs` | 561 | -50 | ğŸŸ¡ ç®€åŒ– |
| `src/lsp/indexer.rs` | 141 | -100 | ğŸŸ¢ é‡æ„ |
| `src/mcp/mod.rs` | 229 | -30 | ğŸŸ¢ ç®€åŒ– |
| `src/cli/shell/mod.rs` | 274 | -20 | ğŸŸ¢ ç®€åŒ– |
| `src/cli/shell/context.rs` | 225 | -10 | ğŸŸ¢ ç®€åŒ– |
| `src/cli/shell/completer.rs` | 156 | -15 | ğŸŸ¢ ç®€åŒ– |
| `src/index.rs` | 323 | +50 | ğŸŸ¡ é‡æ„ |

**æ€»è®¡**ï¼š
- æ–°å¢ä»£ç ï¼š~500 è¡Œï¼ˆå¼•æ“å±‚ï¼‰
- åˆ é™¤ä»£ç ï¼š~225 è¡Œï¼ˆç®€åŒ–å®¢æˆ·ç«¯ï¼‰
- å‡€å¢åŠ ï¼š~275 è¡Œ
- **ä»£ç è´¨é‡æå‡**ï¼šé«˜ï¼ˆç»Ÿä¸€æŠ½è±¡ï¼Œå¯æµ‹è¯•æ€§å¼ºï¼‰

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```rust
#[tokio::test]
async fn test_arc_clone_is_cheap() {
    let graph = CodeGraph::with_nodes(10000);
    
    let start = std::time::Instant::now();
    for _ in 0..100000 {
        let _clone = graph.clone();
    }
    let elapsed = start.elapsed();
    
    // 100K å…‹éš†åº”è¯¥åœ¨æ¯«ç§’çº§
    assert!(elapsed.as_millis() < 100);
}

#[tokio::test]
async fn test_mvcc_non_blocking_reads() {
    let engine = EngineHandle::new(path);
    
    // å¯åŠ¨é•¿æ—¶é—´è¿è¡Œçš„ç´¢å¼•é‡å»º
    let rebuild = tokio::spawn({
        let e = engine.clone();
        async move {
            e.rebuild().await.unwrap();
        }
    });
    
    // åŒæ—¶è¿›è¡ŒæŸ¥è¯¢ï¼ˆä¸åº”è¯¥é˜»å¡ï¼‰
    let start = std::time::Instant::now();
    let graph = engine.graph().await;
    let query_time = start.elapsed();
    
    // å³ä½¿åœ¨é‡å»ºæœŸé—´ï¼ŒæŸ¥è¯¢ä¹Ÿåº”è¯¥æå¿«
    assert!(query_time.as_millis() < 10);
    
    rebuild.await.unwrap();
}
```

### é›†æˆæµ‹è¯•

```rust
#[tokio::test]
async fn test_lsp_mcp_shell_share_engine() {
    let engine = EngineHandle::new(path);
    
    // æ¨¡æ‹Ÿ LSP
    let lsp_task = {
        let e = engine.clone();
        tokio::spawn(async move {
            e.rebuild().await.unwrap();
        })
    };
    
    // æ¨¡æ‹Ÿ MCP æŸ¥è¯¢
    let mcp_task = {
        let e = engine.clone();
        tokio::spawn(async move {
            let results = e.query("example").await;
            assert!(!results.is_empty());
        })
    };
    
    // æ¨¡æ‹Ÿ Shellï¼ˆåŒæ­¥æ¥å£ï¼‰
    let shell_graph = engine.graph_blocking();
    assert!(shell_graph.node_count() >= 0);
    
    lsp_task.await.unwrap();
    mcp_task.await.unwrap();
}
```

### æ€§èƒ½åŸºå‡†

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn benchmark_snapshot(c: &mut Criterion) {
    let rt = tokio::runtime::Runtime::new().unwrap();
    let engine = EngineHandle::new(PathBuf::from("."));
    
    rt.block_on(engine.rebuild()).unwrap();
    
    c.bench_function("snapshot_old", |b| {
        b.iter(|| {
            // æ—§æ–¹å¼ï¼šå…‹éš†æ•´ä¸ª Naviscope
            let navi = old_engine.clone();
            black_box(navi);
        });
    });
    
    c.bench_function("snapshot_new", |b| {
        b.iter(|| {
            // æ–°æ–¹å¼ï¼šArc clone
            let graph = rt.block_on(engine.graph());
            black_box(graph);
        });
    });
}

criterion_group!(benches, benchmark_snapshot);
criterion_main!(benches);
```

---

## âœ… è¿ç§»æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1ï¼šå‡†å¤‡ï¼ˆ1 å¤©ï¼‰

- [ ] åˆ›å»º `src/engine/` æ¨¡å—
- [ ] å®ç° `CodeGraph` çš„ Arc åŒ…è£…ç‰ˆæœ¬
- [ ] å®ç° `CodeGraphBuilder`
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µ2ï¼šå¼•æ“å±‚ï¼ˆ2 å¤©ï¼‰

- [ ] å®ç° `NaviscopeEngine`
- [ ] å®ç° `EngineHandle`
- [ ] å®ç° `snapshot()` å’Œ `rebuild()`
- [ ] ç¼–å†™å¹¶å‘æµ‹è¯•

### é˜¶æ®µ3ï¼šè¿ç§» LSPï¼ˆ2 å¤©ï¼‰

- [ ] æ›´æ–° `LspServer` ä½¿ç”¨ `EngineHandle`
- [ ] é‡æ„ `indexer.rs`
- [ ] æ›´æ–°æ‰€æœ‰ LSP åŠŸèƒ½ï¼ˆhover, goto, etc.ï¼‰
- [ ] éªŒè¯åŠŸèƒ½å®Œæ•´æ€§

### é˜¶æ®µ4ï¼šè¿ç§» MCPï¼ˆ1 å¤©ï¼‰

- [ ] æ›´æ–° `McpServer` ä½¿ç”¨ `EngineHandle`
- [ ] ç®€åŒ– `execute_query`
- [ ] éªŒè¯æ‰€æœ‰ MCP å·¥å…·

### é˜¶æ®µ5ï¼šè¿ç§» Shellï¼ˆ1 å¤©ï¼‰

- [ ] æ›´æ–° `ShellContext` ä½¿ç”¨ `EngineHandle`
- [ ] æ›´æ–° `Completer` ä½¿ç”¨åŒæ­¥æ¥å£
- [ ] éªŒè¯æ‰€æœ‰ Shell å‘½ä»¤

### é˜¶æ®µ6ï¼šæ¸…ç†ä¼˜åŒ–ï¼ˆ1 å¤©ï¼‰

- [ ] åˆ é™¤æ—§çš„ `Naviscope` ç»“æ„
- [ ] æ›´æ–°æ–‡æ¡£
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å‘å¸ƒè¯´æ˜

**é¢„è®¡æ€»æ—¶é—´**ï¼š8-10 å¤©

---

## ğŸ¯ ç»“è®º

| æ–¹é¢ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ€§èƒ½æå‡** | â­â­â­â­â­ | å¿«ç…§è·å–æå‡ 5000xï¼Œå†…å­˜é™ä½ 90% |
| **ä»£ç è´¨é‡** | â­â­â­â­â­ | ç»Ÿä¸€æŠ½è±¡ï¼Œä»£ç å‡å°‘ 20% |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | æ›´å®¹æ˜“ç†è§£å’Œæ‰©å±• |
| **å¹¶å‘æ€§** | â­â­â­â­â­ | MVCC å®ç°çœŸæ­£çš„éé˜»å¡è¯»å– |
| **è¿ç§»é£é™©** | â­â­â­â­ | å¯é€æ­¥è¿ç§»ï¼Œé£é™©å¯æ§ |

**æ¨èè¡ŒåŠ¨**ï¼šâœ… **ç«‹å³å¼€å§‹é‡æ„**

é‡æ„å¸¦æ¥çš„æ”¶ç›Šè¿œå¤§äºæˆæœ¬ï¼Œä¸”å½“å‰ä»£ç åº“è§„æ¨¡é€‚ä¸­ï¼Œæ˜¯é‡æ„çš„æœ€ä½³æ—¶æœºã€‚
